---
type: post
date: "2020-05-22T11:24:19+02:00"
title: "Go и приложение-клиент для Music Player Daemon"
tags:
    - Ymuse
    - софт
    - опенсорс
    - MPD
    - Media Player Daemon
    - разработка
    - Go
    - GTK
    - GitHub
    - Linux
    - Ubuntu
    - Yktoo Solutions
image: "https://res.cloudinary.com/yktoo/image/upload/blog/vwonidluzk5sxpscdz4e.jpg"
series: ymuse
---

Наконец-то могу рассказать, чем занимался последние три недели.

Провёл я их очень продуктивно: освоил новый перспективный язык программирования [Go](https://golang.org/).

Освоил настолько, что написал на нём приложение-медиаплеер [Ymuse](/software/ymuse) или, точнее, клиент для {{< fl "Music Player Daemon" >}}.

<!--more-->

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/vwonidluzk5sxpscdz4e.jpg" "Go Gopher поднимает бокал за здравие Ymuse." >}}

## Music Player Daemon

Сначала о том, что вообще такое [Music Player Daemon](https://www.musicpd.org/) ({{< fl "MPD" >}}).

Он представляет собой сервис (на айтишном жаргоне *демон*), который работает в фоновом режиме в недрах компьютера и способен воспроизводить музыку или стриминговое Интернет-аудио (Интернет-радио).

Помимо воспроизведения звука, сервис этот внешне никак себя не проявляет. Чтобы им управлять, требуется специальная программа, которую традиционно называют **клиентом**, и этих клиентов [есть десятки видов](https://www.musicpd.org/clients/) под разные платформы — от {{< fl "Windows" >}} до {{< fl "Wear OS" >}}.

Когда я впервые познакомился с такой концепцией разделения компонентов на невизуальный (воспроизводящий аудио) и визуальный, то был немного озадачен, однако довольно быстро осознал её удобство.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/jxl4vaketbwhgfkmrza2.svg" "Как работает Music Player Daemon." >}}

{{< fl "MPD" >}} берёт на себя управление музыкальной библиотекой (сканирование и индексирование аудиофайлов) и проигрывание файлов, а программу-клиента можно подобрать по вкусу. В такой архитектуре клиентов у {{< fl "MPD" >}}-демона может быть сколько угодно, причём они вообще могут располагаться на другом компьютере или даже мобильном телефоне — подключение к нему осуществляется по сетевому протоколу.

Нередко используется конфигурация, когда {{< fl "MPD" >}} крутится на микрокомпьютере типа {{< fl "Raspberry Pi" >}}, подключенном к колонкам, а управляют им с компьютера или через мобильное приложение.

Также {{< fl "MPD" >}} поддерживает плейлисты (списки воспроизведения) и стандартное стриминговое аудио, благодаря чему становятся доступны тысячи Интернет-радиостанций.

Кстати, в Линуксе есть смысл вместе с {{< fl "MPD" >}} сразу поставить пакет `mpdris2`, который свяжет его со стандартным интерфейсом медиаплеера {{< fl "MPRIS" >}}. Тогда демоном можно будет управлять стандартными медиа-клавишами (перемотка, пауза, стоп и т.д.).

## Ymuse

Теперь о том, зачем, собственно, понадобился ещё один {{< fl "MPD" >}}-клиент.

В своё время я перепробовал несколько существующих клиентов и в итоге остановился на минималистичном [Sonata](https://www.nongnu.org/sonata/), который практически полностью меня устраивал, за исключением пары моментов:

* Неудобный вызов часто используемых мной функций через вложенные меню.
* Неповоротливость с большим плейлистами (на несколько тысяч треков).

Последний пункт был следствием того, что {{< fl "Sonata" >}} написана на {{< fl "Python" >}}, который, как известно, не славится особой производительностью.

В общем, терпел я, терпел, и в конце концов не выдержал и написал свой клиент, который получил название [Ymuse](/software/ymuse) и иконку в виде бокала для мартини, напоминающего букву `Y`:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/wlfb8v23knjqaefztiwg.png" "Иконка Ymuse." >}}

## Go Go Go

Для реализации {{< fl "Ymuse" >}} я выбрал молодой, но многообещающий язык [Go](https://golang.org/), разрабатываемый {{< fl "Google" >}}.

{{< spoiler "Что ещё за Go?" >}}
{{< fl "Go" >}} — язык со строгой типизацией, который нативно компилируется под огромное количество платформ и архитектур, от {{< fl "Linux" >}} до {{< fl "Android" >}} и от {{< fl "SPARC" >}} до {{< fl "ARM" >}}. Это делает его весьма перспективной заменой устаревшему и довольно неуклюжему {{< fl "C++" >}}.

Несмотря на то, что ему едва исполнилось **12** лет, рост его популярности в последние годы бьёт рекорды.

{{< fl "Go" >}} очень дружественен к программисту, синтаксисом напоминая {{< fl "Python" >}}, а также предоставляет поддержку многопоточности «из коробки».

Ну и самое, пожалуй, главное для того, чтобы язык не зачах где-нибудь на обочине истории, это мощная стандартная библиотека функций, а также тысячи опенсорсных библиотек, любую из которых можно подключить к проекту одной командой `go get …`.

Именно наличие двух готовых библиотек — [gompd](https://github.com/fhs/gompd) для коммуникации с {{< fl "MPD" >}}-демоном и [gotk3](https://github.com/gotk3/gotk3), позволяющей работать с графическим интерфейсом {{< fl "GTK" >}} — сделало возможным создание практически полной функциональной копии {{< fl "Sonata" >}} за *пару недель* (!) работы по вечерам.

Для изучения {{< fl "Go" >}} есть отличный официальный курс [A Tour of Go](https://tour.golang.org/), где можно сразу же запускать примеры кода. Также очень порекомендую вот это видео, где за семь часов рассказывается обо всех основных аспектах языка:

{{< youtube "YS4e4q9oBaU" >}}

{{< /spoiler >}}

С моим плейлистом на **12K+** треков {{< fl "Ymuse" >}} работает визуально быстрее раза в два-три «Сонаты», и это ещё без каких-либо оптимизаций.

## Версия Ymuse v0.7

На данный момент выпущена версия программы **0.7**, которая выглядит так:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/mkosprfb6pxouv8sta3b.png" "Ymuse v0.7." >}}

Пока что доступны [бинарные сборки](https://github.com/yktoo/ymuse/releases) только под **64**-битный {{< fl "Linux" >}} (`.deb`, `.rpm` и `.tar.gz`). Если будет потребность, добавлю и другие платформы.

### Возможности

Список возможностей текущей версии:

* Подключение к локальному или сетевому серверу {{< fl "MPD" >}}, автоматическое восстановление подключения.
* Отображение очереди воспроизведения, сортировка по любому свойству, перемешивание, удаление треков из очереди.
* Фильтрация очереди по подстроке.
* Сохранение очереди в виде плейлиста (существующего или нового).
* Просмотр и поиск по библиотеке {{< fl "MPD" >}}.
* Просмотр списка плейлистов, удаление и переименование плейлиста.
* Собственный список потоков (Интернет-радиостанций) с возможностью добавления, удаления и редактирования элементов.
* Настройка отображаемых столбцов в списке воспроизведения.
* Настройка отображаемого текста в плеере (используется синтаксис {{< fl "Go template" >}}).
* Переключение режимов {{< fl "MPD" >}} ({{< fl "random" >}}, {{< fl "repeat" >}} и {{< fl "consume" >}}).
* Перемотка трека в произвольное место.

### Планы

В планах ещё довольно многое:

* Автоматизированное тестирование интерфейса.
* ~~Поддержка мультиязычности.~~ Готово!
* ~~Сборка в виде {{< fl "snap" >}}-пакета.~~ Готово!
* Загрузка изображения обложки альбома.
* ~~Просмотр библиотеки не только по файлам (а также по альбомам, исполнителям и т.д.).~~ Готово!
* Драг-н-дроп в очереди воспроизведения.
* Больше настроек.
* Поддержка нескольких соединений с разными {{< fl "MPD" >}}.

Некоторые вещи пока не удаётся реализовать из-за несовершенства вышеупомянутых библиотек, но, благодаря тому, что они на {{< fl "GitHub" >}}, можно будет прислать свои исправления.
