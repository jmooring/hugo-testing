---
type: post
date: "2023-04-07T15:45:31+02:00"
title: "Commento — всё. Да здравствует Comentario!"
tags:
    - облако
    - Commento
    - Comentario
    - Disqus
    - Docker
    - Linux
    - веб
    - софт
    - разработка
    - Go
    - Angular
image: "https://res.cloudinary.com/yktoo/image/upload/v1680875488/blog/aymiialjtcr6gxvtlh7d.png"
series: comentario
software: comentario
---

Я долго использовал сервер комментариев {{< fl "Commento" >}} на этом и на некоторых других веб-сайтах. Я даже, помнится, написал [инструкцию](0350) по запуску {{< fl "Commento" >}} при помощи {{< fl "Docker Compose" >}}. Несколько лет назад {{< fl "Commento" >}} позиционировался как лёгкая и бесплатная альтернатива {{< fl "Disqus" >}}, {{< fl "Facebook Comments" >}} и т.д. для добавления функционала комментариев на веб-страницы.

Но шло время, и сейчас можно с уверенностью констатировать, что {{< fl "Commento" >}} мёртв.

Поэтому я и решил перезапустить проект под новым именем **[Comentario](https://comentario.app/)** (именно так, с одним {{< fl "m" >}})!

<!--more-->

## Commento заброшен

В какой-то момент {{< fl "Commento" >}} просто перестал развиваться. За последние два года в проекте не было ни единого коммита, и ещё дольше — ни одного существенного улучшения. Очевидно, что проект заброшен автором, несмотря на постоянно растущий [список проблем](https://gitlab.com/commento/commento/-/issues).

В один прекрасный день меня окончательно достали его глюки, так что я решил сам создать альтернативный продукт (ранее я по похожим причинам разработал [Sound Switcher Indicator](/software/sound-switcher-indicator) и [Ymuse](/software/ymuse) — и это действительно оказалось отличным выходом).

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1680875488/blog/aymiialjtcr6gxvtlh7d.png" >}}

## Встречайте Comentario

Так я ступил на долгий путь разработки — точнее, переработки — сервера комментариев. Я назвал его {{< fl "Comentario" >}} — «комментарий» по-испански: прозрачный намёк на его родство с {{< fl "Commento" >}}, означающим то же самое, но по-итальянски.

Если совсем просто, **[Comentario](https://comentario.app/)** — это практически полностью переписанный {{< fl "Commento" >}}. Нумерация его версий [началась](https://gitlab.com/comentario/comentario/-/releases) с версии **2.0.1** (основанной на последней доступной версии **1.8.0** его предшественника).

В {{< fl "Comentario" >}} переделаны все три его составные части:

* Бэкенд (Go)
* Встраиваемая часть с комментариями ({{< fl "Typescript" >}}, транспилируемый в чистый {{< fl "ES6 Javascript" >}})
* Административный интерфейс ({{< fl "Angular" >}})

Вплоть до своей текущей [версии 2.3.0](https://gitlab.com/comentario/comentario/-/releases/v2.3.0) структура базы данных всё ещё сохраняет полную совместимость с оригинальной БД {{< fl "Commento" >}}, но вся программная часть по сути написана заново.

## И что тут нового?

Чем же отличается {{< fl "Comentario" >}} от своего предшественника {{< fl "Commento" >}}?

Список отличий огромен — просто как следствие объёма выполненной работы по переписыванию кода.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1680877677/blog/qyoppijmu3zffyk9usah.png" "Административный интерфейс Comentario." "border shadow" >}}

В настоящий момент функционал {{< fl "Comentario" >}} полностью покрывает всё, что умел {{< fl "Commento" >}}, а также предлагает кое-что ещё. Из основного:

* {{< fl "Comentario" >}} использует все новейшие версии ПО: {{< fl "Go" >}} 1.20, {{< fl "Postgres" >}} 15.x (с сохранением совместимости вплоть до 9.6), {{< fl "ES6" >}} и так далее.
* Исправлены все проблемы с {{< fl "OAuth" >}}-провайдерами ({{< fl "Google" >}}, {{< fl "GitHub" >}}, {{< fl "GitLab" >}}, {{< fl "Twitter" >}}), а также с аватарами пользователей.
* **Встраиваемая часть**:
    * Код модернизирован и переписан на {{< fl "Typescript" >}}.
    * Вёрстка оптимизирована для экранов всех размеров.
    * Всплывающие диалоги логина, регистрации и справки по {{< fl "Markdown" >}}.
    * Формы логина, регистрации и редактора комментариев используют {{< fl "HTML" >}}-элемент `form` и атрибут `autocomplete`, благодаря чему эти они стали совместимыми с менеджерами паролей.
    * Улучшения для {{< fl "WCAG" >}} (универсальный доступ), включая навигацию с клавиатуры.
    * Добавлена ненавязчивая анимация.
    * Поддержка отмены (<kbd>Escape</kbd>) и применения (<kbd>Enter</kbd>, <kbd>Ctrl</kbd><kbd>Enter</kbd> в многострочном поле) диалогов с клавиатуры.
    * Сотни прочих изменений и исправлений.
* **Административный интерфейс**:
    * Поддержка экранов любых размеров от мобильных до больших десктопных;
    * Поддержка многоязычности;
    * Новая страница дашборда со статистикой по всем доменам пользователя;
    * Настоящая аутентификация при помощи {{< fl "HTTP-only" >}}-кук;
    * Нормальная валидация ввода;
    * Функция клонирования домена;
    * Экспорт данных домена скачивает файл вместо отправки уведомления на скачивание по емэйлу;
* Автоматизированные тесты интерфейса на базе {{< fl "Cypress" >}} (в процессе).

## Производительность

Модель данных {{< fl "Commento" >}} была, говоря откровенно, незрелой, а местами просто безумной, в результате чего сильно страдало быстродействие продукта.

Так, одна из ключевых функций сервера, загрузка комментариев, использовала запрос к базе данных для получения комментариев на странице, потом *по запросу на каждого автора комментариев*, а потом ещё *по запросу на каждый комментарий* для получения оценок голосования. Это, мягко выражаясь, полный капец, товарищи. Если у вас страница с **500** комментариями, оставленными **100** авторами, то загрузка комментариев для неё отправляет **601** {{< fl "SQL" >}}-запрос к БД!

В {{< fl "Comentario" >}} это безумие устранено: *все комментарии, авторы и оценки загружаются одним запросом*.

Работа с БД была организована плохо и во множестве других мест, хоть не не настолько плохо, как в примере выше. В {{< fl "Comentario" >}} также устранено несколько утечек ресурсов, добавлена надёжная обработка ошибок и исправлено множество проблем с безопасностью и валидацией пользовательского ввода.

Структура БД вплоть до текущей версии {{< fl "Comentario" >}} [**2.3.0**](https://gitlab.com/comentario/comentario/-/releases/v2.3.0) остаётся без изменений; я решил сначала исправить все проблемы в коде сервера и клиента, но модель данных точно следующая на очереди.

## Что дальше?

Всё вышеперечисленное — только начало. Я планирую добавить ещё множество крутых фич, отсутствовавших в {{< fl "Commento" >}}).

Пока что вы можете:

* Оставить комментарий [ниже](#blog-post-comments) (конечно же, при помощи {{< fl "Comentario" >}})
* Увидеть {{< fl "Comentario" >}} в действии на [демонстрационном сайте](https://demo.comentario.app/)
* Просмотреть [документацию по Comentario](https://docs.comentario.app/)
* Отправить баг-репорт [в GitLab](https://gitlab.com/comentario/comentario)
* Скачать и установить [Comentario 2.3.0](https://gitlab.com/comentario/comentario/-/releases/v2.3.0)
