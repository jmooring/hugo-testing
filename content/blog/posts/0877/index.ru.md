---
type: post
date: "2023-09-24T15:43:15+02:00"
title: "3.0.0-rc1"
tags:
    - Comentario
    - веб
    - софт
    - разработка
    - пререлиз
    - Go
    - Angular
image: "https://res.cloudinary.com/yktoo/image/upload/v1695568197/blog/f2ynsaagus8veslakeuc.png"
series: comentario
software: comentario
---

После пяти месяцев активнейшей разработки и **189** коммитов, камня на камне не оставивших от [легаси-кода](0862), вышла пререлизная версия {{< fl "Comentario" >}} — [3.0.0-rc1](https://gitlab.com/comentario/comentario/-/releases/v3.0.0-rc1).

[Comentario](/software/comentario) — это быстрый и мощный свободный сервер комментариев для веб-страниц, написанный на {{< fl "Go" >}} и {{< fl "Angular" >}}.

## Что нового

<!--more-->

Нового здесь *примерно всё*, несмотря на то, что внешний вид приложения остался похожим на версию **2.x**.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1695567045/blog/rdyckksgb6lyymmvqjnl.gif" "Административный интерфейс Comentario 3.x." "border shadow" >}}

### Структура базы данных

БД новой версии **не имеет ничего общего** с предыдущей, унаследованной от {{< fl "Commento" >}}. Это означает, что при апгрейде потребуется миграция имеющихся данных.

Эта миграция должна выполниться полностью автоматически при первом запуске Comentario, и она была многократно протестирована на разных версиях исходных данных. Загвоздка, однако, в том, что старая структура была, мягко говоря, несовершенна, и гарантировать успешность процесса во всех случаях я не возьмусь.

К счастью, механизм установки миграций в Comentario позволяет выпускать обновлённые версии, чем можно будет воспользоваться при обнаружении проблем. Пишите багрепорты на [GitLab](https://gitlab.com/comentario/comentario/-/issues).

После успешной миграции старая БД будет удалена, поэтому **резервная копия** не просто желательна — она **абсолютно необходима**.

В чём преимущества новой структуры БД? Она намного стройнее и логичнее, в ней добавлено множество ограничений целостности, гарантирующих правильность данных; кроме того, она гораздо лучше оптимизирована в плане производительности (я [рассказывал](0862) о проблемах у {{< fl "Commento" >}} при работе с БД).

### Единая база пользователей

В новой версии Comentario полностью переработана работа с пользователями. В отличии от {{< fl "Commento" >}}, где были два пересекающихся списка — владельцев доменов и комментаторов, — в Comentario единая база пользователей, зарегистрированных в системе, и их роли в каждом домене задаются отдельно.

В наличии имеются следующие роли:

* {{< fl "Owner" >}} — владелец домена.
* {{< fl "Moderator" >}} — модератор домена.
* {{< fl "Commenter" >}} — комментатор.
* {{< fl "Read-only" >}} — комментатор без права оставлять новые комментарии.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1695562983/blog/qiwf5tdw3u7blx7jdinh.png" "Страница менеджера пользователей." "border shadow" >}}

Помимо этого, добавлено понятие *суперпользователя* ({{< fl "superuser" >}}), по сути являющегося администратором системы. Он может удалять, редактировать и банить (тоже новая возможность!) пользователей.

### Конфигурация

Системная [конфигурация](https://edge.docs.comentario.app/en/configuration/) поделена на две части: [статическую](https://edge.docs.comentario.app/en/configuration/backend/static/) и [динамическую](https://edge.docs.comentario.app/en/configuration/backend/dynamic/).

К первой относятся настройки БД, мэйл-сервера, провайдеров аутентификации и т.п.

Ко второй — настройки регистрации и комментирования, и, как можно догадаться из названия, их можно менять на ходу.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1695565324/blog/c0zhs0mforweeoz1tqxd.png" "Динамическая конфигурация системы." "border shadow" >}}

### Статистика

Визуально в плане статистики пока что ничего не изменилось, но под капотом Comentario собирает намного, намного больше данных о посещениях. Кроме того, всё это регистрируется на уровне отдельной страницы, а не по всему домену. Эти данные обезличены, так что комментаторам не стоит опасаться за свою безопасность:

* {{< fl "IP" >}}-адрес (по умолчанию фиксируются только первые два его байта);
* Используемая версия {{< fl "HTTP" >}}-протокола;
* Страна;
* Название и версия браузера;
* Название и версия операционной системы;
* Тип устройства (компьютер, планшет, мобильный телефон, телевизор).

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1695568197/blog/f2ynsaagus8veslakeuc.png" "Дашборд Comentario." "border shadow" >}}

Отображение и фильтрацию статистики по новым данным планируется добавить в будущих версиях.

### Модерация

Наконец-то появилась возможность просмотреть *все комментарии домена*, по ним можно также искать, фильтровать по статусу и т.д.

У доменов добавились настройки модерации: можно автоматически ставить в очередь на одобрение комменты со ссылками, с изображениями, а также написанные недавно зарегистрировавшимися авторами или теми, у кого ещё нет необходимого количества одобренных комментов.

Также теперь можно подключать [внешние сервисы](https://edge.docs.comentario.app/en/configuration/frontend/domain/extensions/) фильтрации спама и токсичного контента ({{< fl "Akismet" >}}, {{< fl "APILayer" >}}, {{< fl "Perspective API" >}}) и настраивать их конфигурацию для каждого домена отдельно.

При этом у каждого поставленного на модерацию комментария будет показана причина, по которой это произошло. Например:

> {{< fl "Pending moderation: Domain policy requires moderation on comments by anonymous users" >}}

### Прочее

* Загрузка аватаров пользователей.
* Логин через {{< fl "Facebook" >}}.
* Неинтерактивный (в фоновом режиме) [Single Sign-On](https://edge.docs.comentario.app/en/configuration/frontend/domain/authentication/sso/).
* Изображения в комментах (с возможностью отключить).
* Возможность запретить ссылки в комментах.
* Опция для замены содержимого главной страницы.
* Комментарии добавляются на страницу при помощи [веб-компонента](https://edge.docs.comentario.app/en/configuration/embedding/comments-tag/) `<comentario-comments>`, дополнительные настройки можно задавать в атрибутах тега.

Ну и, разумеется, сотни прочих доработок и исправлений.

## Демо-версия

Поскольку это пререлиз, он пока не установлен на этом сайте, но его можно увидеть в действии (и попробовать на зуб) на специальном демо-сайте:

{{< button "https://demo.comentario.app/" "Посмотреть демо-сайт" "btn-primary mb-3" >}}

А здесь доступна его админка — логиньтесь с емэйлом `admin@admin` и паролем `admin`:

{{< button "https://edge.comentario.app/" "Демо админки Comentario" "btn-primary mb-3" >}}

## Миграция

Если вы хотите опробовать новую версию в деле — в пробных, разумеется, целях, поскольку это пререлиз — то стоит сначала ознакомиться с разделом документации [Migration](https://edge.docs.comentario.app/en/installation/migration/).

## Что дальше

Сейчас я занят доработкой [документации](https://edge.docs.comentario.app/) и написанием {{< fl "end-2-end" >}}-тестов для покрытия всего нового функционала — работа, конечно, титаническая.

Когда я буду более-менее уверен в качестве нового кода, последует финальный релиз.

К бета-тестированию приглашаются все желающие. Шлите багрепорты и фичреквесты в [баг-трекер](https://gitlab.com/comentario/comentario/-/issues).
