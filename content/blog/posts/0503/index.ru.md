---
type: post
date: "2019-12-13T16:01:40+01:00"
title: "Резервное копирование контента с Cloudinary"
tags:
    - сайт
    - Интернет
    - Cloudinary
    - резервное копирование
    - Python
image: "https://res.cloudinary.com/yktoo/image/upload/blog/vxh8pjqvldsi2pzcdsxm.png"
---

Вскоре после моего [переезда](0452) на [Cloudinary](https://cloudinary.com/invites/lpov9zyyucivvxsnalc5/l6ccxxrfxv0mdc6iewg8) для хостинга изображений и видео, я закономерно задался вопросом: как теперь это всё богатство резервировать?

Ничто не вечно под луной, и облака в том числе. Или можно в один прекрасный день, скажем, лишиться своего аккаунта вместе с доступом. Поэтому резервное копирование — задача более чем актуальная.

<!--more-->

На платных планах {{< fl "Cloudinary" >}} предлагает вариант резервного копирования в {{< fl "Amazon S3 bucket" >}}, но на бесплатном тарифе эта функция недоступна.

## Скрипт резервного копирования

Поскольку хостинг обладает богатыми возможностями по интеграции при помощи своих [API](https://cloudinary.com/documentation/cloudinary_references), я нисколько не сомневался, что сделать скрипт для резервного копирования контента будет совсем несложно.

Так и вышло. Я набросал удобный, рабочий вариант на {{< fl "Python 3" >}}, копирующий все фото и видео на локальный диск, меньше, чем за час: [cloudinary-backup](https://github.com/yktoo/yktoo.com/blob/master/_dev_/cloudinary-backup).

### Установка и настройка

Чтобы использовать скрипт, нужно:

* Установить пакет {{< fl "cloudinary" >}}: `sudo pip3 install cloudinary`
* Установить переменную окружения `CLOUDINARY_URL=cloudinary://<ключ_API>:<пароль_API>@<имя_облака>` — это значение можно скопировать прямо в заголовке {{< fl "Cloudinary Dashboard" >}}.
* Подкрутить переменную `BACKUP_DIR` в заголовке [скрипта](https://github.com/yktoo/yktoo.com/blob/master/_dev_/cloudinary-backup), чтобы она указывала на желаемую локальную папку.

### Запуск

После этого можно скрипт просто запускать (при запуске с ключом командной строки `-v` вывод будет намного подробнее):

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/sau6blvq4tvsnwpjjpg1.gif" "Работа скрипта резервного копирования Cloudinary." >}}

Скрипт сравнивает содержимое облачного хостинга и локального диска, скачивая только те изображения и видео, которые либо отсутствуют локально, либо имеют отличающийся размер.

Один из нюансов, связанных с работой {{< fl "Cloudinary" >}}, состоит в том, что {{< fl "Admin API" >}}, используемый для получения списков контента, является лимитированным по частоте использования. Но этот лимит составляет **500** запросов в час, и за один запрос можно получить до **500** элементов списка, так что, если у вас на хостинге меньше **250 тыс.** файлов, этого должно быть достаточно.

### Удаление «лишних» файлов

Если программу запустить с ключом `-d`, она также удалит локальные файлы, отсутствующие в {{< fl "Cloudinary" >}}.

## Исходный код

Исходный код скрипта [доступен на GitHub](https://github.com/yktoo/yktoo.com/blob/master/_dev_/cloudinary-backup).
