---
type: post
date: "2013-03-03T00:00:00Z"
title: "Индикатор-переключатель звукового устройства для Убунту"
series: sound-switcher-indicator
tags:
    - GitHub
    - Launchpad
    - Linux
    - PulseAudio
    - Python
    - Sound Switcher Indicator
    - Ubuntu
    - Unity
    - звук
    - индикатор
image: "https://res.cloudinary.com/yktoo/image/upload/blog/nxq0nd14z9ut1387.png"
software: sound-switcher-indicator
---

Я не выдержал и написал индикатор для переключения звуковых устройств (входа/выхода) в Ubuntu.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/nxq0nd14z9ut1387.png" >}}

<!--more-->

Сколько лет пользовался Ubuntu и её оболочкой Unity, столько и пытался найти индикатор ([application indicator](http://unity.ubuntu.com/projects/appindicators/)) для удобного переключения звукового устройства. Индикаторов под Unity насоздавали уже вагон и маленькую тележку, включая совершенно бессмысленные, на мой взгляд, но такой насущной вещи, как селектор выхода, так никто и не сподобился разработать. Поэтому каждый раз мне приходилось запускать апплет Sound, ждать, пока он запустится, выбирать нужную вкладку и переключать вход или выход. Особенно часто я пользуюсь переключателем для перенаправления звука на мой [Bluetooth-адаптер Logitech](0141), чтобы слушать музыку на хорошей акустике.

В конце концов моё терпение лопнуло, и я занялся изучением принципов работы индикаторов. Быстро выяснилось, что написать индикатор для Unity очень просто, особенно на Python. Так я создал самый первый прототип переключателя, который использовал команду `pacmd` для смены выхода ({{< fl "sink" >}}), а также разбирал её вывод, чтобы составить список доступных аудиоустройств.

Приложение состояло из сотни строк на Питоне и в принципе работало, но всё-таки это было не очень серьёзно — список устройств сам не обновлялся, на переключение устройства в другом месте индикатор тоже никак не реагировал. Ну и к тому же требовал установленного `pulseaudio-utils`.

Всё это было как-то некошерно, так что я взялся за изучение [PulseAudio API](http://freedesktop.org/software/pulseaudio/doxygen/) — очень ~~утомительное~~ увлекательное занятие. Тут надо ещё отметить, что библиотека PulseAudio по своей природе полностью асинхронная, так что обработку её событий очень желательно выполнять в отдельном потоке.

После долгих экспериментов с несколько ущербной реализацией многопоточности в Python (один только {{< wiki "Global_Interpreter_Lock" "en" "GIL" >}} чего стоит), я наконец добился полностью стабильной работы индикатора. Меню содержит три секции: входные устройства (отсортированные по имени), выходные устройства (то же самое) и статические пункты.

Значок индикатора сделал в Inkscape:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/blog/lq2uaiz7thp90010.png" >}}

Любые изменения состояния сервера PulseAudio отражаются на содержимом меню, причём, даже если оно открыто.

Следующей задачей было создать установочный .deb-пакет для Убунту, чтобы приложением могли легко пользоваться все желающие, и вот тут-то меня ждало самое настоящее испытание. Могу с уверенностью сказать, что написать многопоточный индикатор на Питоне заметно проще, чем собрать его в пакет и опубликовать на Launchpad. В Сети множество статей на эту тему, но при их прочтении меня постоянно преследовало ощущение, что все они описывают, как управлять самолётом в воздухе, не объясняя, как, собственно, нужно взлетать (для интересующихся темой настоятельно советую начать с прочтения [документации по Distutils](http://docs.python.org/2/distutils/), после этого многое становится ясно. Следующим шагом может быть [stdeb](https://github.com/astraw/stdeb)).

В общем, приложение собрано и доступно:

* [Исходный код](https://github.com/yktoo/indicator-sound-switcher) на GitHub;
* Пакет `indicator-sound-switcher` в [моём Launchpad PPA](https://launchpad.net/~yktooo/+archive/ppa).

Чтобы его установить:

    sudo add-apt-repository ppa:yktooo/ppa
    sudo apt-get update
    sudo apt-get install indicator-sound-switcher

О багах сообщайте в [трекер на GitHub](https://github.com/yktoo/indicator-sound-switcher/issues).
