---
type: post
date: "2023-12-09T10:12:17+01:00"
title: "3.1.0"
tags:
    - Comentario
    - веб
    - софт
    - разработка
    - релиз
    - Go
    - Angular
    - Рождество
image: "https://res.cloudinary.com/yktoo/image/upload/v1702113479/blog/bjjqfyprqw9ddphehlto.jpg"
imageCredit: "AI-generated image."
series: comentario
software: comentario
---

Вот уж и Рождество уж на носу, а у нас вышла версия [Comentario 3.1.0](https://gitlab.com/comentario/comentario/-/releases/v3.1.0)!

[Comentario](/software/comentario) — это быстрый и мощный свободный сервер комментариев для веб-страниц, написанный на {{< fl "Go" >}}.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702113479/blog/bjjqfyprqw9ddphehlto.jpg" "С наступающими на нас праздниками!" >}}

## Что нового

Изменений в релизе немало, ниже список самых существенных.

<!--more-->

### Поддержка Gravatar

Сервис [Gravatar](https://gravatar.com/) давно стал стандартом для централизованного хранения аватаров: единожды сохранённый, аватар будет автоматически появляться на каждом поддерживающем его сервисе. Ну, а теперь — и в {{< fl "Comentario" >}}.

Здесь уже присутствовала возможность загрузить свой аватар в профиле, в новой версии появилась кнопка {{< fl "Download from Gravatar" >}}:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702114302/blog/hu6hupxcavxgzjzvnjns.png" "Кнопка Gravatar в профиле пользователя." "border shadow" >}}

Более того, если {{< fl "Gravatar" >}} активирован в [настройках Comentario](https://docs.comentario.app/en/configuration/backend/dynamic/domain.defaults.usegravatar/), аватар будет автоматически скачиваться при регистрации пользователя и обновляться после каждого логина.

Также эта опция включает автозагрузку аватаров пользователей, импортируемых из [Commento](https://docs.comentario.app/en/installation/migration/commento/) и [WordPress](https://docs.comentario.app/en/installation/migration/wordpress/) (но не из  [Disqus](https://docs.comentario.app/en/installation/migration/disqus/), так как он не экспортирует емэйлы).

### Импорт из WordPress

Кстати, на тему импорта. В версии **3.1.0** добавлена поддержка загрузки комментов и пользователей [из WordPress](https://docs.comentario.app/en/installation/migration/wordpress/), являющегося одной из наиболее популярных систем управления контентом в мире. {{< fl "Comentario" >}} способен импортировать данные из его дампа в формате {{< fl "RSS" >}} (он же {{< fl "WXR" >}}).

А ещё, страница импорта стала лучше выглядеть:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702114874/blog/aif8rayuavj4zfon2xg0.png" "Импорт данных, в качестве источника выбран WordPress." "border shadow" >}}

{{< fl "Comentario" >}} также стал поддерживать прямой импорт из `.gz`/`.zip`-архивов и из несжатых дамп-файлов. Также он понимает `.zip`-архивы с подкаталогами внутри.

### Улучшения в Markdown

В качестве {{< fl "Markdown" >}}-парсера вместо (уже неподдерживаемого) [Blackfriday](https://github.com/russross/blackfriday) стал использоваться [goldmark](https://github.com/yuin/goldmark) — быстрый, гибкий и следующий стандартам. Помимо прочего, теперь стало возможным лучше конфигурировать особенности и диалекты формата {{< fl "Markdown" >}}.

Одной из таких фич стала поддержка *«прямых» переводов строк* ({{< fl "hard line breaks" >}}): одиночный перевод строки в тексте комментария приведёт к такому же эффекту в итоговом {{< fl "HTML" >}}:

```markdown
О дайте, дайте
Мне свободу!
```

отобразится в виде двух строк, а не одной, как раньше:

> О дайте, дайте\
> Мне свободу!

Сильно подкручена очистка {{< fl "HTML" >}} от зловредного контента, отныне в нём оставляется лишь сильно ограниченный набор разрешённых тегов.

### Заморочки с удалением

По историческим причинам в {{< fl "Comentario" >}} удалённые комментарии никуда не пропадали: они лишь помечались удалёнными, а их текст стирался. Так было сделано, потому что иначе при удалении пропадали бы и все дочерние комментарии.

У {{< fl "Commento" >}} — предшественника {{< fl "Comentario" >}} — имелся специальный {{< fl "HTML" >}}-атрибут `data-hide-deleted`, позволяющий скрыть удалённые комментарии на конкретной странице. С чем я лично был не согласен: подобное поведение должно настраиваться либо глобально, либо хотя бы на уровне отдельного домена.

Сейчас эта проблема решена: в новом релизе есть целый ряд улучшений на тему работы с удалёнными комментами.

#### Опция конфигурации

Настройка [Show deleted comments](https://docs.comentario.app/en/configuration/backend/dynamic/domain.defaults.comments.showdeleted/) определяет, должны ли отображаться удалённые комментарии. По умолчанию она включена, благодаря чему сохраняется совместимость с предыдущими версиями.

Если эту опцию выключить, удалённый комментарий будет пропадать сразу же после удаления вместе со всеми ответами на него.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702118404/blog/ju5y5lxojeyizzihug8s.png" "Настройка отображения удалённых комментов." "border shadow" >}}

Опция, однако, не влияет на отображение удалённых комментариев в административном интерфейсе — там для этого отдельная кнопка.

#### Операция Purge Comments

На странице Операций с доменом ({{< fl "Domain Operations" >}}) появилась кнопка {{< fl "Purge comments" >}} («Очистить комментарии»). Она позволяет окончательно вычистить все помеченные к удалению комменты — разумеется, вместе со всеми дочерними.

Там же присутствует опция удаления комментариев, оставленных ныне удалёнными пользователями (раньше они также не удалялись):

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702118843/blog/copztohrgilop2yruvya.png" "Диалог подтверждения очистки комментариев." >}}

#### Опции при удалении и бане пользователей

У пользователя появился выбор как поступить со своим «творческим наследием» при удалении аккаунта:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702119126/blog/gnud07gz4tx6qpwqfswu.png" "Диалог подтверждения при удалении аккаунта." >}}

Он может либо пометить все свои комментарии удалёнными (и сохранить ответы), либо удалить их с концами (вместе с ответами).

Точно такие же опции присутствуют при бане и удалении пользователя в административном интерфейсе.

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702119396/blog/gew4mlu0kfqnyioju2ll.png" "Диалог подтверждения бана." >}}


### Редактор атрибутов тега комментов

На странице свойств домена, в разделе {{< fl "Installation" >}} (установка), появилась кнопка опций, раскрывающая форму конфигурации тега встраиваемых комментариев. С её помощью можно настроить поведение {{< fl "Comentario" >}} на конкретной странице:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702119836/blog/gke9noynvyvrq4psgyil.png" "Редактор опций HTML-тега." "border shadow" >}}

### Максимальный уровень вложенности

Внимательный читатель, конечно же, заметил новую опцию на скриншоте выше: *Maximum visual nesting level*. Она определяет *визуальный* уровень вложенности комментариев на странице, по умолчанию **10**. Настройка никак не влияет на фактический уровень вложенности (он неограничен), а лишь меняет отображение комментов.

Вот, например, как выглядит дерево комментариев с максимальным уровнем **2**:

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702120460/blog/wgsazk7o35ycykr8s4ec.png" "Дерево комментариев с двумя уровнями." "border shadow" >}}

### … и прочее

Ещё изменения:

* Отображение аватара в свойствах пользователя (в админке).
* Диалог регистрации комментера требует ввода «стойкого» пароля.
* Исправлено отображение картинок в комментах, чтобы они не были шире самого коммента.
* Исправлено отображение статистики: удалённые комментарии теперь не учитываются.
* Много других исправлений.

Для полного списка изменений см. [CHANGELOG](https://gitlab.com/comentario/comentario/-/blob/master/CHANGELOG.md).

## Демо-версия

Увидеть новую версию в действии, а также её административный интерфейс (логин с емэйлом `admin@admin` и паролем `admin`), можно на демо-сайте:

{{< button "https://demo.comentario.app/" "Демо-сайт комментариев" "btn-primary mb-3" >}}
{{< button "https://edge.comentario.app/" "Демо админки Comentario" "btn-primary mb-3" >}}

## Установка

Если вы хотите установить {{< fl "Comentario" >}}, вот ссылки на документацию:

* [Getting started](https://docs.comentario.app/en/getting-started/).
* [Installation](https://docs.comentario.app/en/installation/).
* [Migration](https://docs.comentario.app/en/installation/migration/).

{{< imgfig "https://res.cloudinary.com/yktoo/image/upload/v1702132791/blog/vhfwsdpiknlyvzehr2ed.jpg" >}}
